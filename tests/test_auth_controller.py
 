import pytest
from flask import Flask
from backend.authentication.controllers.auth_controller import auth_controller

@pytest.fixture
def client():
    app = Flask(__name__)
    app.register_blueprint(auth_controller, url_prefix='/auth')
    with app.test_client() as client:
        yield client


def test_login_success(client, mocker):
    mock_auth_service = mocker.patch('backend.authentication.controllers.auth_controller.auth_service')
    mock_auth_service.authenticate.return_value = True
    response = client.post('/auth/login', json={'username': 'testuser', 'password': 'testpass'})
    assert response.status_code == 200
    assert response.json['message'] == 'Login successful'


def test_login_invalid_credentials(client, mocker):
    mock_auth_service = mocker.patch('backend.authentication.controllers.auth_controller.auth_service')
    mock_auth_service.authenticate.return_value = False
    response = client.post('/auth/login', json={'username': 'testuser', 'password': 'wrongpass'})
    assert response.status_code == 401
    assert response.json['message'] == 'Invalid credentials'


def test_login_exception(client, mocker):
    mock_auth_service = mocker.patch('backend.authentication.controllers.auth_controller.auth_service')
    mock_auth_service.authenticate.side_effect = Exception('Test Error')
    response = client.post('/auth/login', json={'username': 'testuser', 'password': 'testpass'})
    assert response.status_code == 500
    assert response.json['message'] == 'Login failed'
