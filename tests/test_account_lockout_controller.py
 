import pytest
from flask import Flask
from backend.authentication.controllers.account_lockout_controller import account_lockout_controller

@pytest.fixture
def client():
    app = Flask(__name__)
    app.register_blueprint(account_lockout_controller, url_prefix='/auth')
    with app.test_client() as client:
        yield client


def test_account_lockout_controller_login_success(client, mocker):
    mock_account_lockout_service = mocker.patch('backend.authentication.controllers.account_lockout_controller.AccountLockoutService')
    mock_account_lockout_service.record_attempt_and_check_lockout.return_value = (False, 'Login successful')
    response = client.post('/auth/login', json={'user_id': 'testuser', 'password': 'correctpass'})
    assert response.status_code == 200
    assert response.json['message'] == 'Login successful'


def test_account_lockout_controller_invalid_data(client):
    response = client.post('/auth/login', json={'user_id': 'testuser'})
    assert response.status_code == 400
    assert response.json['error'] == 'Invalid data'


def test_account_lockout_controller_account_locked(client, mocker):
    mock_account_lockout_service = mocker.patch('backend.authentication.controllers.account_lockout_controller.AccountLockoutService')
    mock_account_lockout_service.record_attempt_and_check_lockout.return_value = (True, 'Account locked')
    response = client.post('/auth/login', json={'user_id': 'testuser', 'password': 'wrongpass'})
    assert response.status_code == 423
    assert response.json['error'] == 'Account locked'


def test_account_lockout_controller_authentication_failure(client, mocker):
    mock_account_lockout_service = mocker.patch('backend.authentication.controllers.account_lockout_controller.AccountLockoutService')
    mock_account_lockout_service.record_attempt_and_check_lockout.side_effect = lambda user_id, success: (False, 'Authentication failed') if not success else (False, 'Login successful')
    response = client.post('/auth/login', json={'user_id': 'testuser', 'password': 'wrongpass'})
    assert response.status_code == 401
    assert response.json['error'] == 'Authentication failed'
